<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Choose>
    <When Condition="$(NCrunchOriginalSolutionDir) != '' And $(NCrunchOriginalSolutionDir) != '*Undefined*'">
      <PropertyGroup>
        <FodySolutionDir>$(NCrunchOriginalSolutionDir)</FodySolutionDir>
      </PropertyGroup>
    </When>
    <When Condition="$(SolutionDir) != '' And $(SolutionDir) != '*Undefined*'">
      <PropertyGroup>
        <FodySolutionDir>$(SolutionDir)</FodySolutionDir>
      </PropertyGroup>
    </When>
    <When Condition="$(SolutionDir) == '' Or $(SolutionDir) == '*Undefined*'">
      <PropertyGroup>
        <FodySolutionDir>$(MSBuildProjectDirectory)\..\</FodySolutionDir>
      </PropertyGroup>
    </When>
  </Choose>
  <PropertyGroup>
    <ProjectWeaverXml>$(ProjectDir)FodyWeavers.xml</ProjectWeaverXml>
    <FodySignAssembly Condition="$(FodySignAssembly) == '' Or $(FodySignAssembly) == '*Undefined*'">$(SignAssembly)</FodySignAssembly>
    <FodyPath Condition="$(FodyPath) == '' Or $(FodyPath) == '*Undefined*'">$(MSBuildThisFileDirectory)..\</FodyPath>
  </PropertyGroup>
  <Choose>
    <When Condition="'$(MSBuildRuntimeType)'=='Core'">
      <PropertyGroup>
        <FodyAssemblyPath>$(FodyPath)netstandardtask</FodyAssemblyPath>
      </PropertyGroup>
    </When>
    <Otherwise>
      <PropertyGroup>
        <FodyAssemblyPath>$(FodyPath)netclassictask</FodyAssemblyPath>
      </PropertyGroup>
    </Otherwise>
  </Choose>
  <PropertyGroup>
    <FodyAssembly>$(FodyAssemblyPath)\Fody.dll</FodyAssembly>
  </PropertyGroup>
  <UsingTask
      TaskName="Fody.WeavingTask"
      AssemblyFile="$(FodyAssembly)" />
  <Target
      AfterTargets="AfterCompile"
      Condition="Exists('@(IntermediateAssembly)') And $(DesignTimeBuild) != true And $(DisableFody) != true"
      Name="FodyTarget"
      DependsOnTargets="$(FodyDependsOnTargets)"
      Inputs="@(IntermediateAssembly->'%(FullPath)');$(FodyKeyFilePath);$(ProjectWeaverXml)"
      Outputs="$(TargetPath)">

    <Fody.WeavingTask
          AssemblyPath="@(IntermediateAssembly)"
          IntermediateDir="$(ProjectDir)$(IntermediateOutputPath)"
          KeyOriginatorFile="$(KeyOriginatorFile)"
          AssemblyOriginatorKeyFile="$(AssemblyOriginatorKeyFile)"
          NuGetPackageRoot="$(NuGetPackageRoot)"
          ProjectDirectory="$(MSBuildProjectDirectory)"
          SolutionDir="$(FodySolutionDir)"
          References="@(ReferencePath)"
          SignAssembly="$(FodySignAssembly)"
          ReferenceCopyLocalPaths="@(ReferenceCopyLocalPaths)"
          DefineConstants="$(DefineConstants)"
          DebugType="$(DebugType)"
          DocumentationFilePath="@(DocFileItem->'%(FullPath)')"
          MsBuildThisFileDirectory="$(MSBuildThisFileDirectory)"
          WeaverProbingPaths="$(WeaverProbingPaths)"
      >

      <Output
        TaskParameter="ExecutedWeavers"
        PropertyName="FodyExecutedWeavers" />
    </Fody.WeavingTask>

  </Target>

  <UsingTask
    TaskName="Fody.VerifyTask"
    AssemblyFile="$(FodyAssembly)" />
  <Target Condition="'$(NCrunch)' != '1' And $(FodyExecutedWeavers) != '' And $(DisableFody) != true"
      AfterTargets="AfterBuild"
      Name="FodyVerifyTarget"
      DependsOnTargets="$(FodyVerifyDependsOnTargets)">

    <Fody.VerifyTask
          ProjectDirectory="$(MSBuildProjectDirectory)"
          TargetPath="$(TargetPath)"
          SolutionDir="$(FodySolutionDir)"
          DefineConstants="$(DefineConstants)"
      />
  </Target>

  <!--Support for ncrunch-->
  <ItemGroup  Condition="'$(NCrunch)' == '1'">
    <None Include="$(FodyAssemblyPath)\*.*" />
  </ItemGroup>

</Project>